<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" >
<head th:insert="fragments/header.html::head('Product')"></head>
<body>
	<!-- Menu -->
	<div th:replace="fragments/menu.html::menu(currentRoute='/order')"></div>
	
	<div style="margin-top: 130px;"></div>
	
	<div class="container" style="margin-bottom: 50px;">
		<a href="#" class="btn btn-primary" data-toggle="modal" data-target="#createOrderModal">Add New Order</a>
	</div>
	
	<!-- product table -->
	<div class="container">
		<div class="mb-5" th:if="${param.success}">
			<span class="alert alert-success d-flex flex-row">商品登録が正常に完了いたしました。</span>
		</div>

		<div class="mb-5" th:if="${param.updated}">
			<span class="alert alert-warning d-flex flex-row">商品変更するのが正常に完了いたしました。</span>
		</div>

		<div class="mb-5" th:if="${param.deleted}">
			<span class="alert alert-danger d-flex flex-row">商品を削除しました。</span>
		</div>
		
		<table id="addressTable" class="table table-bordered table-striped">
			<thead class="thead-dark text-center text-white" style="background-color: rgb(132, 132, 132);">
			  <tr>
				<th scope="col">Address Id</th>
				<th scope="col">Region</th>
				<th scope="col">Address Name</th>
				<th scope="col">Post Code</th>
				<th scope="col">Address</th>
				<th scope="col">Action</th>
			  </tr>
			</thead>
			<tbody>
			  <!-- <tr th:each="address:${deliveryAddresses}" th:object="${address}">
				<th scope="row" style="text-align: right;padding-right: 15px;" th:text="*{deliveryAddressId}"></th>
				<td>
					<div>
						<div th:text="'#'+*{regionId}"></div>
						<div th:text="*{regionName}"></div>
					</div>
				</td>
				<td>
					<span th:text="*{addressName}"></span>
					<span th:if="*{main==1}" class="btn btn-primary btn-sm">main</span>
				</td>
				<td th:text="*{postCode}"></td>
				<td th:text="*{address}"></td>
				<td class="text-center">
					<button 
						action="update" 
					>Edit</button>
					<button 
						action="delete" 
					>Delete</button>
				</td>
			  </tr> -->
			</tbody>
		  </table>

		<!-- Create Product Modal -->
		<div class="modal fade" id="createOrderModal" tabindex="-1" role="dialog" aria-labelledby="createOrderModalTitle" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLongTitle">Create Order</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<!-- Page One -->
				<div class="createOrderPageOne">
					<div class="form-group d-flex flex-row align-items-center" style="margin-bottom: 10px;">
						<label for="customerId" style="width: 200px;">Customer :</label>
						<select name="customerId" id="customerId" class="form-control">
							<option></option>
							<option th:each="option:${customerOptions}" th:value="${option.value}" th:text="${option.title}"></option>
						</select>
					</div>
					<div class="form-group d-flex flex-row align-items-center" style="margin-bottom: 10px;">
						<label for="addressId" style="width: 200px;">Delivery Address :</label>
						<select name="addressId" id="addressId" class="form-control"></select>
					</div>
				</div>
				
				<!-- Page Two -->
				<div class="createOrderPageTwo" style="display: none;">
					<div class="form-group d-flex flex-row align-items-center" style="margin-bottom: 10px;">
						<label for="productId" style="width: 200px;">Product :</label>
						<select name="productId" id="productId" class="form-control">
						</select>
					</div>
					<!-- <div class="form-group d-flex flex-row align-items-center" style="margin-bottom: 10px;">
						<label for="addressId" style="width: 200px;">Delivery Address :</label>
						<select name="addressId" id="addressId" class="form-control"></select>
					</div> -->
				</div>
			</div>
			<div class="createOrderPageOne">
				<div class="modal-footer d-flex justify-content-center">
					<button id="next" type="button" class="btn btn-secondary">Next</button>
				</div>
			</div>
			<div class="createOrderPageTwo" style="display: none;">
				<div class="modal-footer d-flex justify-content-center">
					<button id="prev" type="button" class="btn btn-secondary">Previous</button>
					<button id="create-order" type="button" class="btn btn-primary">Create Order</button>
				</div>
			</div>
			</div>
		</div>
		</div>
	</div>

  <!-- common function -->
  <script>
	var reload = (param)=>{
		if(!param){
			window.location.href = window.location.href;
			return;
		}

		if(window.location.href.includes("?")){
			window.location.href = window.location.href.split("?")[0] + `?${param}`;
		}else{
			window.location.href = window.location.href + `?${param}`;
		}
	}
	$(document).ready(function(){
		// $('#addressTable').DataTable();
	})
  </script>
  <!-- order create -->
  <script>
	$(document).ready(function(){
		
		const renderSelectOption = (element,addressOptions)=>{
			if(addressOptions && addressOptions.length>0){
				let addressOptionElementStr = '';

				addressOptions.map(({value,title})=>{
					addressOptionElementStr += `<option value="${value}">${title}</option>`
				});
				$(element).html(addressOptionElementStr);
			}else{
				$(element).html(`<option value=""></option>`);
			}
		}

		$("#prev").click(()=>{
			renderSelectOption($("#productId"),[]);
			$(".createOrderPageOne").toggle();
			$(".createOrderPageTwo").toggle();
		})

		$("#next").click(()=>{
			$(".createOrderPageOne").toggle();
			$(".createOrderPageTwo").toggle();
			const addressId = $("#addressId").val();
			if(addressId){
				const url = `api/v1/address/${addressId}/products`;
				const method = "GET";
				const headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				};
				fetch(
					url, 
					{method, headers})
					.then((response)=>{
						if (response.ok) {
							return response.json().then((ans)=>{
								renderSelectOption($("#productId"),ans.data);
							})
						} else {
							return response.json().then(error => {
								// bindingResult(error);
								throw new Error('Error response received'); // Throw an error to trigger the catch block
							});
						}
					})
					.catch((error)=>{
					console.log(error);
				});	
			}
		})

		$("#customerId").change(function(){
			const customerId = $(this).val();
			if(customerId){
				const url = `api/v1/customer/${customerId}/address`;
				const method = "GET";
				const headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				};
				fetch(
					url, 
					{method, headers})
					.then((response)=>{
						if (response.ok) {
							return response.json().then((ans)=>{
								renderSelectOption($("#addressId"),ans.data);
							})
						} else {
							return response.json().then(error => {
								// bindingResult(error);
								throw new Error('Error response received'); // Throw an error to trigger the catch block
							});
						}
					})
					.catch((error)=>{
					console.log(error);
				});	
			}
		})

	})
  </script>
  
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>